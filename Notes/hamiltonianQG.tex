\documentclass[12pt]{article}

\usepackage{graphicx}
\usepackage{natbib}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{subfig}
\usepackage{color}
\usepackage{cleveref}
\allowdisplaybreaks

\begin{document}

\title{Hamiltonian Theory of Geophysical Fluids}

\section{One-Layer Quasi-Geostrophy}{
    \textbf{Assumptions} \\
    In the quasi-geostrophic model, there are a number of assumptions about the fluid that are made:
    \begin{itemize}
        \item The density, $\rho$, is constant
        \item The flow is incompressible and non-diffusive
        \item The fluid is inviscid
        \item The fluid is in hydrostatic balance
        \item Horizontal velocities are depth-indepenedent
        \item The Rossby number is very small, and
        \item Deformations in the fluid surface are small compared to the fluid depth
    \end{itemize}
    We will also impose the following assumption to simplify calculations:
    \begin{itemize}
        \item The bottom surface is flat
    \end{itemize}

    The one-layer QG model can be written as,
    $$
    \partial_t q + J(\psi, q + \beta y) = 0,
    $$
    with the following potential vorticity (PV) relation
    $$
    q = \nabla^2 \psi - \frac{f_0^2}{gH} \psi.
    $$

    The Hamiltonian can be thought of as the energy in the system and takes the form,
    $$
    H =  \frac12 \iint \vec\nabla\psi \cdot \vec\nabla\psi + \frac{f_0^2}{g H} \psi^2 \, dA
    $$
    The canonical matrix is
    $$
    \mathbf{J} = -J(q + \beta y,\cdot)
    $$
    with the Casimirs being functions of the PV,
    $$
    \mathcal{C} = \iint C(q + \beta y) \, dA,
    $$
    where $C(q)$ is an arbitrary function. From this we form the constrained Hamiltonian,
    \begin{equation}
        \mathcal{H} = \iint  \frac12 \vec\nabla\psi \cdot \vec\nabla\psi + \frac12 \frac{f_0^2}{g H} \psi^2 + C(q + \beta y) \, dA
        \label{eqn:qg_ol_h}
    \end{equation}

    \subsection{First Variation}{
        To compute the steady states we must first the first variational derivative of the above functional:
        \begin{align*}
            \delta \mathcal{H}
            & = \iint \vec\nabla\psi \cdot \vec\nabla \delta \psi + \frac{f_0^2}{g H} \psi \delta \psi + C'(q + \beta y) \delta q \, dA, \\
            & = \iint -\psi \left[ \nabla^2 \delta \psi - \frac{f_0^2}{g H} \delta \psi \right]  + C'(q + \beta y) \delta q \, dA, \\
            & = \iint \left[ - \psi + C'(q + \beta y) \right]  \delta q  \, dA.
        \end{align*}
        From here we find that the steady solutions, which have a zero first variational derivative, must satisfy the following,
        $$
        \psi_s = C'(q_s + \beta y).
        $$
        Here, and throughout, we use a subscript s to denote steady solution.
    }

    \subsection{Second Variation}{
      Similarly, we compute the second variational derivative,
      \begin{align*}
          \delta^2 \mathcal{H}
          & = \iint \left[ - \psi + C'(q + \beta y) \right]  \delta^2 q  - \delta \psi \delta q +  C''(q + \beta y) (\delta q)^2  \, dA, \\
          & = \iint \left[ - \psi + C'(q + \beta y) \right]  \delta^2 q
          + \vec\nabla \delta \psi \cdot \vec \nabla \delta \psi
          +\frac{f_0^2}{gH} (\delta \psi)^2+  C''(q + \beta y) (\delta q)^2  \, dA,
      \end{align*}
      after integrating by parts.

      Next, we evaluate the second variation at an arbitrary steady solution,
      \begin{align*}
          \delta^2 \mathcal{H}_s
          & = \iint \vec\nabla \delta \psi \cdot \vec \nabla \delta \psi + \frac{f_0^2}{gH} (\delta \psi)^2+  C''(q_s + \beta y) (\delta q)^2  \, dA \\
          & = \delta^2 H_s + \iint C''(q_s + \beta y) (\delta q)^2  \, dA.
      \end{align*}
      Note that the $\delta^2 H_s$ term is positive definite and the Casimir term is sign definite.
    }
    \subsection{Linear Stability Theorems}{
        To prove stability it is sufficient to show that the second variation is sign definite. (FJP: explain why?).

        \subsubsection{First Theorem (Positive Definiteness)}{
            The first theorem is the easiest and corresponds to showing where the second variation is positive definite.  It is readily seen that this occurs when
            $$
            C''(q_s + \beta y) > 0.
            $$

            So for any steady flow that satisfies $\psi_s = C'(q_s + \beta y)$ and the inequality above, we have a linearly stable flow.

            As an example of flows one may have examined before, if we assume that the steady solution only depends on latitude, $y$, then $\Psi = \Psi(y)$, and we can differentiate our equation that defines the steady state to obtain,
            $$
            U_s = -C''(q_s + \beta y) \left(\frac{dq_s}{dy} + \beta \right)
            $$
            where we used the fact that $U_s = - \frac{d \Psi_s}{dy}$.

            If we require that $C'' > 0$, then this is equivalent to (assuming the PV is not zero)
            $$
            U_s \left(\frac{d Q_s}{dy} + \beta \right) < 0.
            $$
            since we are only concerned with the signs.
        }

        \subsubsection{Second Theorem (Negative Definiteness)}{
            This is not as obvious at the first theorem, but will use two theorems provide some bounds. The first is Poincar\'e's inequality, and the second is the triangle inequality

            Poincar\'e's inequality: Consider the boundary value problem
            $$
                \nabla^2 \phi + \lambda \phi = 0, (x,y) \in \Omega, \quad
                \left. \phi \right|_{\partial \Omega} = 0
            $$
            whose eigenvalues are strictly positive. Then if $h(x,y)$ is a twice-continuously differentiable function satisfying $\left. h\right|_{\partial D} = 0$, then
            $$
                \iint_\Omega\nabla h \cdot\nabla h \, dA \le \frac{1}{\Lambda}\iint_\Omega (\nabla^2 h)^2 \, dA
            $$
            where $\Lambda = \min \{ \lambda \}$. For the triangle inequality, we just need
            $$
            	2xy \le x^2+y^2
            $$
            which we will use when expanding $(\delta q)^2$.
            $$
            	(\delta q)^2 = \left(\nabla^2\delta\psi - \frac{f_0^2}{gH}\delta\psi \right)^2 \implies 2\frac{f_0^2}{gH}\delta\psi\nabla^2\delta\psi \le (\nabla^2\delta\psi)^2 + \left(\frac{f_0^2}{gH} \right)^2(\delta\psi)^2 
            $$

            Using these two theorems, we have the following:
            \begin{align*}
                \delta^2\mathcal{H}_s
                &= \iint \vec\nabla \delta \psi \cdot \vec \nabla \delta \psi + \frac{f_0^2}{gH} (\delta \psi)^2+  C''(q_s + \beta y) (\delta q)^2  \, dA \\
                &\le \iint \frac{1}{\Lambda}(\nabla^2\delta\psi)^2 + \frac{f_0^2}{gH} (\delta \psi)^2+  C''(q_s + \beta y) (\delta q)^2  \, dA \\
                &= \iint \frac{1}{\Lambda}(\nabla^2\delta\psi)^2 + \frac{f_0^2}{gH} (\delta \psi)^2 \\
                &\quad+  C''(q_s + \beta y) \left[ (\nabla^2 \delta\psi)^2 - 2\frac{f_0^2}{gH}\delta\psi\nabla^2\delta\psi + \left( \frac{f_0^2}{gH} \right)^2 (\delta\psi)^2 \right]  \, dA \\
            \end{align*}
            
            Since $C''(q_s + \beta y) < 0$, by the triangle inequality we have
            \begin{align*}
                \delta^2\mathcal{H}_s
                &\le \iint \frac{1}{\Lambda}(\nabla^2\delta\psi)^2 + \frac{f_0^2}{gH} (\delta \psi)^2 +  2C'' \left[ (\nabla^2 \delta\psi)^2 + \left( \frac{f_0^2}{gH} \right)^2 (\delta\psi)^2 \right]  \, dA \\
                &= \iint \left[ \frac1\Lambda + 2C''\right](\nabla^2\delta\psi)^2 + \left[ \frac{f_0^2}{gH} + 2C''\left(\frac{f_0^2}{gH}\right)^2\right](\delta\psi)^2    
            \end{align*}
            
            
            This gives us two conditions that $C''$ must follow
            $$
                C''(q_s + \beta y) < -\frac{1}{2\Lambda}, \quad\quad C''(q_s + \beta y) < -\frac{gH}{2f_0^2}=-\frac{L_R^2}{2}
            $$
            The value of $\Lambda$ will depend on the geometry of the domain. For example, two commonly used domains are the doubly periodic rectangle and an infinite channel in $x$.
            It can be shown that $\Lambda = 4\pi^2(\frac1{L_x^2} + \frac1{L_y^2})$ for the doubly periodic boundary, and $\Lambda = \frac{\pi^2}{W^2}$ for the channel.
        }
    }

    \subsection{Nonlinear Stability Theorems}{
        To analyze the the nonlinear stability, we introduce the functional
        $$
        \mathcal{N}(\delta q)  = \mathcal{H}(q_s + \delta q) - \mathcal{H}(q_s)
        $$
        since, when expanded about $q_s$, it becomes
        \begin{align*}
            \mathcal{N}(\delta q)
            &= - \mathcal{H}(q_s) + \mathcal{H}(q_s + \delta q) \\
            & = - \mathcal{H}(q_s) + \left[ \mathcal{H}(q_s) + \delta \mathcal{H}(q_s)+ \frac12 \delta^2 \mathcal{H}(q_s) + ... \right] \\
            &= \frac12 \delta^2 \mathcal{H}(q_s) + \mathcal{O}((\delta q)^3)
        \end{align*}

        To leading order, arguments about $\mathcal{N}$ will be the same as arguments about $\delta^2 \mathcal{H}$. But $\mathcal{N}$ also captures the nonlinearity of the Hamiltonian, so more work will be required.

        \begin{align*}
            \mathcal{N}(\delta q)
            &= \mathcal{H}(q_s + \delta q) - \mathcal{H}(q_s) \\
            &= \iint  \frac12 \vec\nabla(\psi_s + \delta \psi) \cdot \vec\nabla(\psi_s + \delta \psi) + \frac12 \frac{f_0^2}{g H} (\psi_s + \delta \psi)^2 + C(q_s + \beta y + \delta q) \, dA \\
            &\quad - \iint  \frac12 \vec\nabla\psi_s \cdot \vec\nabla\psi_s + \frac12 \frac{f_0^2}{g H} \psi_s^2 + C(q_s + \beta y) \, dA \\
            &= \iint \frac12 \vec\nabla\delta\psi \cdot \vec\nabla\delta\psi + \frac12 \frac{f_0^2}{g H} (\delta \psi)^2 + \vec\nabla\psi_s \cdot \vec\nabla\delta\psi + \frac12 \frac{f_0^2}{g H} \psi_s\delta\psi \\
            &\quad + C(q_s + \beta y + \delta q) - C(q_s + \beta y) \, dA \\
            &= \iint -\psi_s \left[ \nabla^2\delta\psi - \frac12 \frac{f_0^2}{g H} \delta\psi \right] + \frac12 \vec\nabla\delta\psi \cdot \vec\nabla\delta\psi + \frac12 \frac{f_0^2}{g H}(\delta\psi)^2 \\
            &\quad + C(q_s + \beta y + \delta q) - C(q_s + \beta y) \, dA \\
            &= \iint \frac12 \vec\nabla\delta\psi \cdot \vec\nabla\delta\psi + \frac12 \frac{f_0^2}{g H}(\delta \psi)^2 + C(q_s + \beta y + \delta q) - C(q_s + \beta y) -C'(q_s + \beta y)\delta q\, dA \\
            &= \frac12 \delta^2 H_s + \iint C(q_s + \beta y + \delta q) - C(q_s + \beta y) -C'(q_s + \beta y)\delta q\, dA
        \end{align*}
        where $H_s$ is the unconstrained Hamiltonian evaluated at the steady state, defined at the beginning of this section.
    }
}

\newpage
\section{Two-Layer Quasi-Geostrophy}{
    \textbf{Assumptions} \\
    All of the same assumptions that are made in the one-layer case will be made.

    The two-layer QG model can be written as,
    $$
    \partial_t q_i + J(\psi_i, q_i + \beta y) = 0,
    $$
    for $i=1,2$ where the PV relations are given by:

    \begin{align*}
        q_1 &= \frac{g'H_1}{f_0^2}\nabla^2 \psi_1 - (\psi_1 - \psi_2) - \psi_1,\\
        q_2 &= \frac{g'H_2}{f_0^2}\nabla^2 \psi_2 - (\psi_2 - \psi_1) + \frac{g'}{f_0} h_b.
    \end{align*}
    We use the convention that $g$ is the full gravity at the surface and $g'$ is the reduced gravity between the two dynamic layers.

    If we want to consider a rigid lid and a flat bottom, then we neglect the last terms in each of these two equations.  We make this choice but can return to this later if we like. We get the following system (Holm \emph{et al.} 1985):

    \begin{equation}
        \left[\begin{array}{c}
        q_1 \\
        q_2
        \end{array}\right]
        =
        \left[\begin{array}{c}
        \frac{1}{\alpha_1}\nabla^2 \psi_1 \\
        \frac{1}{\alpha_2}\nabla^2 \psi_2
        \end{array}\right]
        +
        \left[\begin{array}{cc}
        -1 & 1 \\
        1 & -1
        \end{array}\right]
        \left[\begin{array}{c}
        \psi_1 \\
        \psi_2
        \end{array}\right],
        \quad \alpha_i = \frac{f_0^2}{g'H_i}
    \end{equation}

    Note that previous papers usually assume that the constants in front are equal. This is not the case.  In QG this might not be as important but in SW it will make a big difference.

    \subsection{Hamiltonian}{
        To derive an equation for the energy we must multiply the evolution equation by $\psi_i$ for each $i$ and then sum up over the different layers,
        \begin{align*}
            0 &= \iint \psi_1 \partial_t q_1 + \psi_2 \partial_t q_2 + \psi_1 J(\psi_1, q_1 + \beta y) + \psi_2 J(\psi_2, q_2 + \beta y) \, dA \\
            &= \iint \psi_1 \partial_t q_1 + \psi_2 \partial_t q_2 + \frac12 J(\psi_1^2, q_1 + \beta y) + \frac12 J(\psi_2^2, q_2 + \beta y) \, dA \\
            &= \iint \sum_i \left[\partial_t(q_i \psi_i) - q_i \partial_t\psi_i \right] + \frac12 J(\psi_1^2, q_1 + \beta y) + \frac12 J(\psi_2^2, q_2 + \beta y) \, dA \\
            &= \iint \sum_i \left[\partial_t(q_i \psi_i) - q_i \partial_t\psi_i \right] \, dA \\
            &= \iint \sum_i \partial_t \left (\frac{1}{\alpha_i}\psi_i \nabla^2 \psi_i - \psi_i^2 + \psi_i\psi_{j\ne i} \right) \\
            &\quad - \left( \frac{1}{\alpha_i} \psi_{it} \nabla^2 \psi_i - \psi_i \psi_{it} + \psi_{j \ne i} \psi_{it} \right) \, dA \\
            &= \iint \sum_i \partial_t \left (-\frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i - \psi_i^2 + \psi_i\psi_{j\ne i} \right) \\
            &\quad - \left( -\frac{1}{\alpha_i} \vec\nabla \psi_{it} \cdot \vec\nabla \psi_i - \psi_i \psi_{it} + \psi_{j \ne i} \psi_{it} \right) \, dA \\
            &= \iint \sum_i \partial_t \left (-\frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i - \psi_i^2 \right) + \partial_t (\psi_i\psi_{j\ne i})  \\
            &\quad + \left( \frac{1}{\alpha_i} \vec\nabla \psi_{it} \cdot \vec\nabla \psi_i + \psi_i \psi_{it} \right) - \psi_{j \ne i} \psi_{it} \, dA \\
            &= \iint \sum_i \frac12 \partial_t \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + \psi_i^2 \right] - \partial_t \psi_i\psi_{j\ne i} + \psi_{j \ne i} \psi_{it} \, dA \\
            &= \iint  \sum_i \frac12 \partial_t \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot  \vec\nabla \psi_i + \psi_i^2 \right] - \psi_1 \partial_t \psi_2  -  \psi_2 \partial_t \psi_1\, dA \\
            &= \iint  \sum_i \frac12 \partial_t \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot  \vec\nabla \psi_i + \psi_i^2 \right] -  \partial_t (\psi_1\psi_2)\, dA \\
            &= \frac12 \iint \partial_t \left[ \sum_{i=1}^2 \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + (\psi_1 - \psi_2)^2 \right]\, dA
        \end{align*}

        This yields that the Hamiltonian of the system is the total energy in the system,
        $$
        H = \frac12 \iint \sum_{i=1}^2 \frac{1}{\alpha_i}\vec\nabla \psi_i \cdot \vec\nabla \psi_i + (\psi_1 - \psi_2)^2 \, dA
        $$
        The canonical matrix is
        $$
        \mathbf{J} = \left[\begin{array}{cc}
        -J(q_1 + \beta y, \cdot) & \\
        & -J(q_2 + \beta y, \cdot)
        \end{array}\right]
        $$
        with the Casimirs being functions of the PV,
        $$
        \mathcal{C}_i = \iint C_i(q_i + \beta y) \, dA
        $$
        From this we form the constrained Hamiltonian
        \begin{equation}
            \mathcal{H} = \frac12 \iint \sum_{i=1}^2 \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + 2C_i(q_i + \beta y) \right]+ (\psi_1 - \psi_2)^2 \, dA
            \label{eqn:qg_tl_h}
        \end{equation}

        \subsubsection{Aside: Boundary Conditions}{
            In the derivation above, we used Green's first identity to say $\iint \frac{1}{\alpha_i}\psi_i \nabla^2 \psi_i \, dA = - \iint \frac{1}{\alpha_i} \vec\nabla\psi_i \cdot \vec\nabla\psi_i \, dA$. But this identity depends on the boundary of the domain. Specfically, for an arbitrary $C^1$ function $u$, and a $C^2$ function $v$ on some region $U \subset \mathbb{R}^3$:
            $$
            \int_U u \nabla^2 v + \nabla u \cdot \nabla v \, dV = \oint_{\partial U} u \nabla v \cdot d \vec S
            $$
            If $\iint \frac{1}{\alpha_i}\psi_i \nabla^2 \psi_i \, dA = - \iint \frac{1}{\alpha_i} \vec\nabla\psi_i \cdot \vec\nabla\psi_i \, dA$, then we're clearly saying $\oint \frac{1}{\alpha_i}\psi_i \nabla \psi_i\cdot d \vec S = 0$. By Helmholtz's decomposition theorem, the stream function $\psi_i$ is unique up to a divergenceless function, thus $\psi_i$ can differ by a constant and still be a valid stream function for the velocity. If we assume the domain is simply connected and the boundary is smooth everywhere, there is only on boundary we are concerned with, and each $\psi_i$ is constant on that boundary. Thus, we are free to assume whatever contant value we like. A natural choice is $\left. \psi_i \right|_{\partial D} = 0$, which automatically implies $\oint \frac{1}{\alpha_i}\psi_i \nabla \psi_i \cdot d \vec S = 0$.

            If the domain was not simply connected or not smooth, there would be multiple boundaries to deal with. For example, a rectangle is a simply connected domain, but its boundary has corners. The stream function will be constant on each edge, but the value on one edge may be different from the value on another. We are allowed to arbitrarily choose a value of $\psi_i$ on one of the boundaries, but this dictates the value of $\psi_i$ on the others, so the surface integral may be some non-zero value. Assuming a simply connected, smoothly bounded domain, or a domain that has $\oint \frac{1}{\alpha_i}\psi_i \nabla \psi_i\cdot d \vec S = 0$, makes this problem disappear
        }
    }

    \subsection{First Variation}{
        \begin{align*}
            \delta \mathcal{H} &= \delta \frac12 \iint \sum_{i=1}^2 \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + 2C_i(q_i + \beta y) \right]+ (\psi_1 - \psi_2)^2 \, dA \\
            &= \iint \sum_{i=1}^2 \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \delta\psi_i + C'_i(q_i + \beta y) \delta q_i \right]+ (\psi_1 - \psi_2)(\delta \psi_1 - \delta \psi_2) \, dA \\
            &= \iint \sum_{i=1}^2 \left[ -\frac{1}{\alpha_i} \psi_i \nabla^2 \delta\psi_i + C'_i(q_i + \beta y) \delta q_i - \psi_i(\delta \psi_i - \delta \psi_{j \ne i}) \right] \, dA \\
            &= \iint \sum_{i=1}^2 (-\psi_i + C'_i(q_i + \beta y)) \delta q_i\, dA \\
        \end{align*}

        Since $\delta \mathcal{H} = 0$ for steady solutions, and $q_1$ and $q_2$ are independent coordinates, we have that in vector form
        \begin{equation}
            \vec \psi_s =
            \left[\begin{array}{c}
            \psi_{1s} \\
            \psi_{2s}
            \end{array}\right]
            =
            \left[\begin{array}{c}
            C'_1(q_{1s} + \beta y) \\
            C'_2(q_{2s} + \beta y)
            \end{array}\right]
        \end{equation}
    }

    \subsection{Second Variation}{
        Like the single layer model, the second variation for the two-layer model is
        \begin{align*}
            \delta^2 \mathcal{H} &= \iint \sum_i \left[ - \psi_i + C'_i(q_i + \beta y) \right]  \delta^2 q_i  - \delta \psi_i \delta q_i +  C''_i(q_i + \beta y) (\delta q_i)^2  \, dA \\
            \delta^2 \mathcal{H}_s &= \iint \sum_i \left[ - \psi_{is} + C'_i(q_{is} + \beta y) \right]  \delta^2 q_i  - \delta \psi_i \delta q_i +  C''_i(q_{is} + \beta y) (\delta q_i)^2  \, dA \\
            &= \iint \sum_i - \delta \psi_i \delta q_i +  C''_i(q_{is} + \beta y) (\delta q_i)^2  \, dA \\
            &= \iint \sum_i - \delta \psi_i \left( \frac{1}{\alpha_i} \nabla^2 \delta \psi_i - \delta\psi_i + \delta\psi_{j \ne i} \right) +  C''_i(q_{is} + \beta y) (\delta q_i)^2  \, dA \\
            &= \iint \sum_i \left[ \frac{1}{\alpha_i} \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i + (\delta\psi_i)^2 + C''_i(q_{is} + \beta y) (\delta q_i)^2 \right]  - 2\delta\psi_1\delta\psi_2 \, dA \\
            &= \iint \sum_i \left[ \frac{1}{\alpha_i} \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i + C''_i(q_{is} + \beta y) (\delta q_i)^2 \right]+ (\delta\psi_1 - \delta\psi_2)^2 \, dA \\
            &= \delta^2 H_s + \iint \sum_i C''_i(q_{is} + \beta y)(\delta q_i)^2 \, dA \\
        \end{align*}

        The $\delta^2 H_s$ term is clearly positive definite, while the $C''_i(q_{is} + \beta y)$ term is sign definite. Like in the single-layer case, the definiteness of the second variation depends on the definiteness of the Casimirs.
    }

    \subsection{Linear Stability Theorems}{
        \subsubsection{First Theorem}{
            The first theorem proceeds exactly like it did for the one-layer case. We require the second variation to be positive definite, so
            $$
            C''_i(q_{is} + \beta y) > 0, \quad i=1,2
            $$

            If we assume that the steady solution only depends on latitude, $y$, then $\Psi_i = \Psi_i(y)$, and we can differentiate our equation that defines the steady state to obtain
            $$
            U_{is} = -C''_i(q_{is} + \beta y) \frac{dq_{is}}{dy}
            $$
            or succinctly,
            $$
            U_{is} \left(\frac{d Q_{is}}{dy} + \beta \right) < 0, \quad i=1,2
            $$
        }
        \subsubsection{Second Theorem}{
            We follow a similar pattern to the one-layer case.
            \begin{align*}
                \delta^2\mathcal{H}_s
                &= \iint \sum_i \left[ \frac{1}{\alpha_i} \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i + C''_i(q_{is} + \beta y) (\delta q_i)^2 \right]+ (\delta\psi_1 - \delta\psi_2)^2 \, dA \\
                &\le \iint \sum_i \left[ \frac{1}{\Lambda\alpha_i} (\nabla^2\delta\psi_i)^2 + C''_i(q_{is} + \beta y) (\delta q_i)^2 \right]+ (\delta\psi_1 - \delta\psi_2)^2 \, dA \\
                &\le \iint \sum_i \left[ \frac{1}{\Lambda\alpha_i} (\nabla^2\delta\psi_i)^2 \right]+ (\delta\psi_1 - \delta\psi_2)^2 \, dA \\
                &\quad + 2C''_1(q_{1s} + \beta y) \left[ \left(\frac{1}{\alpha_1} \nabla^2\delta\psi_1 \right)^2 + (\delta\psi_1 - \delta\psi_2)^2 \right] \\
                &\quad + 2C''_2(q_{2s} + \beta y) \left[ \left(\frac{1}{\alpha_2} \nabla^2\delta\psi_2 \right)^2 + (\delta\psi_1 - \delta\psi_2)^2 \right] \\
                &= \iint (\nabla^2\delta\psi_1)^2\left[ \frac{1}{\Lambda\alpha_1} + \frac{2}{\alpha_1^2}C_1'' \right] + (\nabla^2\delta\psi_2)^2\left[ \frac{1}{\Lambda\alpha_2} + \frac{2}{\alpha_2^2}C_2'' \right] \\
                &\quad + (\delta\psi_1-\delta\psi_2)^2[1+2C_1'' + 2C_2''] \, dA \\
            \end{align*}            
            
            This gives the following conditions:
            \begin{align*}
                C_1''(q_{1s} + \beta y) &< -\frac{\alpha_1}{2\Lambda} \\
                C_2''(q_{2s} + \beta y) &< -\frac{\alpha_2}{2\Lambda} \\
                C_1''(q_{1s} + \beta y) + C_2''(q_{2s} + \beta y) &< -\frac12
            \end{align*}
        }
    }

    \subsection{Nonlinear Stability Theorems}{
        We proceed as stated in the single-layer case, by defining $\mathcal{N}$.

        \begin{align*}
            \mathcal{N}(q)
            & = \mathcal{H}(q_s + \delta q) - \mathcal{H}(q_s) \\
            &= \frac12 \iint \sum_{i=1}^2 \left( \frac{1}{\alpha_i}\vec\nabla (\psi_{is} + \delta\psi_i) \cdot \vec\nabla (\psi_{is} + \delta\psi_i) + 2C_i(q_{is} + \beta y + \delta q_i) \right) \\
            &\quad\quad + ((\psi_{1s} + \delta\psi_1) - (\psi_{2s} + \delta\psi_2))^2 \, dA \\
            &\quad\quad - \left[ \frac12 \iint \sum_{i=1}^2 \left( \frac{1}{\alpha_i}\vec\nabla \psi_{is} \cdot \vec\nabla \psi_{is} + 2C_i(q_{is} + \beta y) \right) + (\psi_{1s} - \psi_{2s})^2 \, dA \right] \\
            &= \frac12 \iint \sum_{i=1}^2 \frac{1}{\alpha_i} (2 \vec\nabla\delta\psi_i \cdot \vec\nabla\psi_{is} + \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i) \\
            &\quad\quad + 2\psi_{1s}\delta\psi_1 + (\delta\psi_1)^2 + 2\psi_{2s}\delta\psi_2 + (\delta\psi_2)^2 - 2\psi_{1s}\delta\psi_2 - 2\delta\psi_1\psi_{2s} - 2\delta\psi_1\delta\psi_2 \, dA \\
            &\quad\quad + \iint \sum_{i=1}^2 C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) \, dA \\
            &= \frac12 \iint \sum_{i=1}^2 \frac{1}{\alpha_i} (2 \vec\nabla\delta\psi_i \cdot \vec\nabla\psi_{is} + \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i) \\
            &\quad\quad + (\delta\psi_1 - \delta\psi_2)^2 + 2(\psi_{1s} - \psi_{2s})(\delta\psi_1 - \delta\psi_2) \, dA \\
            &\quad\quad + \iint \sum_{i=1}^2 C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) \, dA \\
            &= \frac12 \iint \sum_{i=1}^2 \frac{1}{\alpha_i} \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i + (\delta\psi_1 - \delta\psi_2)^2 \\
            &\quad\quad + \iint \sum_{i=1}^2 C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) + \vec\nabla\delta\psi_i \cdot \vec\nabla\psi_{is} + \psi_{is}(\delta\psi_i - \delta\psi_{j \ne i}) \, dA \\
            &= \frac12 \delta^2 H_s + \iint \sum_{i=1}^2 C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is}) - \psi_{is}(\nabla^2\delta\psi_i - (\delta\psi_i - \delta\psi_{j \ne i})) \, dA \\
            &= \frac12 \delta^2 H_s + \iint \sum_{i=1}^2 C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) - \psi_{is}\delta q_i \, dA \\
            &= \frac12 \delta^2 H_s + \iint \sum_{i=1}^2 C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) - C'_i(q_{is} + \beta y)\delta q_i \, dA \\
        \end{align*}
    }
    \subsection{Example: Two-Layer Phillips Model (incorrect at the moment)}{
        The Two-Layer Phillips Model is a quasigeostrophic model where two layers of fluid are in a channel with periodic $x$-boundaries, and the basic flow in each layer is independent of $y$ (\emph{i.e.} constant velocity in the $x$-direction in each layer). We follow the above instructions to derive some sufficient conditions for the model.

        \begin{align*}
            U_1, U_2 &= \text{constants} \\
            U_i &= -\partial_y \Psi_i \implies \Psi_i = -U_i y \\
            Q_i &= \nabla^2\Psi_i - F\Psi_i = F U_i y
        \end{align*}
        First stability theorem:
        \begin{align*}
            0 &> U_{is} \left(\frac{d Q_{is}}{dy} + \beta \right) \\
            &= U_{is} (F U_{is} + \beta) \\
        \end{align*}
        Second stability theorem:
        \begin{align*}
            \frac1F &< \frac{U_{is}}{\frac{d Q_{is}}{dy} + \beta} \\
            &= \frac{U_{is}}{F U_{is} + \beta} \\
            \implies 0 &> \frac{\beta}{F}
        \end{align*}

        Since $\beta, F > 0$, the second theorem is never satisfied. The first theorem is true when $U_{is} \in (-\frac{\beta}{F}, 0)$.
    }   
}

\newpage
\section{$N$-Layer Quasi-Geostrophy}{
    The $N$-layer QG model can be written as,
    $$
    \partial_t q_i + J(\psi_i, q_i + \beta y) = 0,
    $$
    for $i=1,...,N$ where the PV relations are given by:
    \begin{align*}
        \left[\begin{array}{c}
        q_1 \\
        \\
        \vdots \\
        \\
        q_N
        \end{array}\right]
        &=
        \left[\begin{array}{c}
        \frac{1}{\alpha_1}\nabla^2 \psi_1 \\
        \\
        \vdots \\
        \\
        \frac{1}{\alpha_N}\nabla^2 \psi_N
        \end{array}\right]
        +
        \left[\begin{array}{ccccc}
        -1 & 1 & & & \\
        1 & -2 & 1 & & \\
        & \ddots & \ddots & \ddots & \\
        & & & & 1 \\
        & & & 1 & -1\\
        \end{array}\right]
        \left[\begin{array}{c}
        \psi_1 \\
        \\
        \vdots \\
        \\
        \psi_N
        \end{array}\right] \\
        \alpha_i &= \frac{f_0^2 \rho_0}{g (\rho_{i+1} - \rho_i) H_i} \text{(constant across all layers)}
    \end{align*}

    Assuming a flat bottom, just as in the two-layer case.

    \subsection{Hamiltonian}{
        To derive an equation for the energy, we do as we did in the two-layer case.
        \begin{align*}
        0 &= \iint \sum_{i=1}^N \psi_i \partial_t q_i + \psi_i J(\psi_i, q_i + \beta y) \, dA \\
        &= \iint \sum_{i=1}^N \psi_i \partial_t q_i + \frac12 J(\psi_i^2, q_i + \beta y) \, dA \\
        &= \iint \sum_i \left[\partial_t(q_i \psi_i) - q_i \partial_t\psi_i \right] \, dA \\
        &= ... \\
        &= \frac12 \iint \partial_t \left[ \sum_{i=1}^N \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + \sum_{i=1}^{N-1} (\psi_i - \psi_{i+1})^2 \right]\, dA
        \end{align*}

        This yields that the Hamiltonian of the system is the total energy in the system,
        $$
        H = \frac12 \iint \sum_{i=1}^N \frac{1}{\alpha_i}\vec\nabla \psi_i \cdot \vec\nabla \psi_i + \sum_{i=1}^{N-1} (\psi_i - \psi_{i+1})^2 \, dA
        $$
        The canonical matrix is
        $$
        \mathbf{J} = \left[\begin{array}{ccc}
        -J(q_1 + \beta y, \cdot) & & \\
        & \ddots & \\
        & & -J(q_n + \beta y, \cdot)
        \end{array}\right]
        $$
        with the Casimirs being functions of the PV,
        $$
        \mathcal{C}_i = \iint C_i(q_i + \beta y) \, dA
        $$
        From this we form the constrained Hamiltonian
        \begin{equation}
        \mathcal{H} = \frac12 \iint \sum_{i=1}^N \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + 2C_i(q_i + \beta y) \right] + \sum_{i=1}^{N-1} (\psi_i - \psi_{i+1})^2 \, dA
        \label{eqn:qg_Nl_h}
        \end{equation}
    }

    \subsection{First Variation}{
        \begin{align*}
        \delta \mathcal{H} &= \delta\frac12 \iint \sum_{i=1}^N \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \psi_i + 2C_i(q_i + \beta y) \right] + \sum_{i=1}^{N-1} (\psi_i - \psi_{i+1})^2 \, dA \\
        &= \iint \sum_{i=1}^N \left[ \frac{1}{\alpha_i} \vec\nabla \psi_i \cdot \vec\nabla \delta\psi_i + C'_i(q_i + \beta y) \delta q_i \right]+ \sum_{i=1}^{N-1} (\psi_i - \psi_{i+1})(\delta \psi_i - \delta \psi_{i+1}) \, dA \\
        &= \iint \sum_{i=1}^N (-\psi_i + C'_i(q_i + \beta y)) \delta q_i\, dA \\
        \end{align*}

        $\delta \mathcal{H} = 0$ for steady solutions, and each $q_i$ is independent, so we have that in vector form
        \begin{equation}
        \vec \psi_s =
        \left[\begin{array}{c}
        \psi_{1s} \\
        \vdots \\
        \psi_{Ns}
        \end{array}\right]
        =
        \left[\begin{array}{c}
        C'_1(q_{1s} + \beta y) \\
        \vdots \\
        C'_N(q_{Ns} + \beta y)
        \end{array}\right]
        \end{equation}
    }

    \subsection{Second Variation}{
        The second variation for the $N$-layer model is
        \begin{align*}
            \delta^2 \mathcal{H} &= \iint \sum_{i=1}^N \left[ - \psi_i + C'_i(q_i + \beta y) \right]  \delta^2 q_i  - \delta \psi_i \delta q_i +  C''_i(q_i + \beta y) (\delta q_i)^2  \, dA \\
            \delta^2 \mathcal{H}_s &= \iint \sum_{i=1}^N \left[ - \psi_{is} + C'_i(q_{is} + \beta y) \right]  \delta^2 q_i  - \delta \psi_i \delta q_i +  C''_i(q_{is} + \beta y) (\delta q_i)^2  \, dA \\
            &= \iint \sum_{i=1}^N - \delta \psi_i \delta q_i +  C''_i(q_{is} + \beta y) (\delta q_i)^2  \, dA \\
            &= \iint \sum_{i=1}^N \left[ \frac{1}{\alpha_i} \vec\nabla\delta\psi_i \cdot \vec\nabla\delta\psi_i + C''_i(q_{is} + \beta y) (\delta q_i)^2 \right] + \sum_{i=1}^{N-1}(\delta\psi_i - \delta\psi_{i+1})^2 \, dA \\
            &= \delta^2 H_s + \iint \sum_{i=1}^N C''_i(q_{is} + \beta y)(\delta q_i)^2 \, dA \\
        \end{align*}

        Which is exactly the same result as the two-layer case, but summing from 1 to $N$.
    }

    \subsection{Linear Stability Theorems}{
        \subsubsection{First Theorem}{
            Our results for linear stability are thus identical to the results for the two-layer case.
            $$
            C''_i(q_{is} + \beta y) > 0, \quad i=1,...,N
            $$

            If we assume that the steady solution only depends on latitude, $y$, then $\Psi_i = \Psi_i(y)$, and we have
            $$
            U_{is} \left(\frac{d Q_{is}}{dy} + \beta \right) < 0, \quad i=1,...,N
            $$
        }
        \subsubsection{Second Theorem}{        
        }
    }

    \subsection{Nonlinear Stability Theorems}{
        If you haven't noticed a pattern by now, we define $\mathcal{N}$ and proceed as before.

        \begin{align*}
            \mathcal{N}(q)
            & = \mathcal{H}(q_s + \delta q) - \mathcal{H}(q_s) \\
            &= \frac12 \iint \sum_{i=1}^N \left( \frac{1}{\alpha_i}\vec\nabla (\psi_{is} + \delta\psi_i) \cdot \vec\nabla (\psi_{is} + \delta\psi_i) + 2C_i(q_{is} + \beta y + \delta q_i) \right) \\
            &\quad\quad + \sum_{i=1}^{N-1}((\psi_{is} + \delta\psi_i) - (\psi_{(i+1)s} + \delta\psi_{i+1}))^2 \, dA \\
            &\quad\quad - \left[ \frac12 \iint \sum_{i=1}^N \left( \frac{1}{\alpha_i}\vec\nabla \psi_{is} \cdot \vec\nabla \psi_{is} + 2C_i(q_{is} + \beta y) \right) + \sum_{i=1}^{N-1}(\psi_{is} - \psi_{(i+1)s})^2 \, dA \right] \\
            &= \frac12 \delta^2 H_s + \iint \sum_{i=1}^N C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) - \psi_{is}\delta q_i \, dA \\
            &= \frac12 \delta^2 H_s + \iint \sum_{i=1}^N C_i(q_{is} + \beta y + \delta q_i) - C_i(q_{is} + \beta y) - C'_i(q_{is} + \beta y)\delta q_i \, dA \\
        \end{align*}
    }
}

\newpage
\section{Shallow Water}{
    \textbf{Assumptions}
    The quasi-geostrophic model is actually an approximation of the Shallow Water Model, so the assumptions made here are very similar to those made above.
    \begin{itemize}
        \item The density, $\rho$, is constant
        \item The flow is incompressible and non-diffusive
        \item The fluid is inviscid
        \item The fluid is in hydrostatic balance
        \item Horizontal velocities are depth-indepenedent
    \end{itemize}

    The SW model can be written as,
    \begin{align*}
        \partial_t \vec u + (\vec u \cdot \vec \nabla) \vec u + f \hat k \times \vec u &= - g \vec \nabla h, \\
        \partial_t h + \vec\nabla \cdot \left( h \vec u \right) & = 0.
    \end{align*}

    \subsection{Hamiltonian}{
        As can be found in Shepherd (1990), the regular Hamiltonian is
        $$
        H = \frac12 \iint h | \vec u |^2 + g h^2 \, dA.
        $$
        The PV is defined as,
        $$
        q = \frac{ \hat k \cdot (\vec \nabla \times \vec u) + f}{h},
        $$
        and is conserved following the motion.

        It can be shown that the canonical matrix is
        $$
        \mathbf{J} = \left[\begin{array}{ccc}
        0 & q & -\partial_x \\
        -q & 0 & -\partial_y \\
        -\partial_x & -\partial_y & 0
        \end{array}\right]
        $$
        and that the Casimirs are
        $$
        \mathcal{C} = \iint hC(q) \, dA.
        $$
        Therefore, the constrained Hamiltonian is,
        $$
        \mathcal{H} =  \iint \frac12  \left( h (u^2 + v^2) + g h^2 \right) + h C(q) \, dA.
        $$
    }

    \subsection{Equations of Motion}{
        Define the Poisson bracket.

        Show that we can recover the equations of motion.
    }

    \subsection{First Variation}{
        The variational derivative is,
        \begin{align*}
            \delta \mathcal{H}
            &=  \iint \left[ \frac12  (u^2 + v^2) + g h  + C(q) \right] \delta h   +  uh  \delta u + vh \delta v   + h C'(q) \delta q \, dA.
        \end{align*}
        But we need to get everything in terms of the variations of height and velocity.  Therefore, we need the identity that
        \begin{align*}
            \iint h C'(q) \delta q \, dA
            &= \iint h C'(q) \delta \frac{ \partial_x v - \partial_y u+ f}{h} \, dA, \\
            &= \iint - C'(q) \frac{ \partial_x v - \partial_y u+ f}{h } \delta h + C'(q) \left(  \partial_x \delta v - \partial_y \delta u \right) \, dA, \\
            &= \iint \left( - C'(q) q \delta h - \partial_x ( C'(q) )  \delta v + \partial_y ( C'(q) ) \delta u \right) \, dA.
        \end{align*}

        If we substitute this into our above equation for the first variation we get,
        \begin{align*}
            \delta \mathcal{H}
            & =  \iint \left[ \frac12  (u^2 + v^2) + g h  + C(q)  - C'(q) q\right] \delta h     \, dA, \\
            & +  \iint \left[ \partial_y ( C'(q) ) + u h \right] \delta u  +  \left[ vh - \partial_x ( C'(q) )  \right] \delta v \, dA.
        \end{align*}
        Steady solutions have a zero first variation and therefore are governed by the following equations,
        \begin{align*}
            \frac12  (u^2 + v^2) + g h & = - C(q)  + C'(q) q ,\\
            u h & = - \partial_y ( C'(q) ) = - C''(q) \partial_y q, \\
            vh  & = \partial_x ( C'(q) ) = C''(q) \partial_x q.
        \end{align*}

        If we restrict ourselves to basic states that are invariant with respect to $x$, then we find that $v= 0$.  This can be used in the first two equations to simplify things.  I would expect that the first two equations reduce down to geostrohic balance but I don't honestly know.  Shepherd 1990 looks at this in some detail.  Maybe a good reference?
    }

    \subsection{Second Variation}{
        Only after we understand the first variation.
    }
}

\end{document}
